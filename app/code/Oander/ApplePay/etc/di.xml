<?xml version="1.0"?>
<!--
/**
 *   /$$$$$$   /$$$$$$  /$$   /$$ /$$$$$$$  /$$$$$$$$ /$$$$$$$
 *  /$$__  $$ /$$__  $$| $$$ | $$| $$__  $$| $$_____/| $$__  $$
 * | $$  \ $$| $$  \ $$| $$$$| $$| $$  \ $$| $$      | $$  \ $$
 * | $$  | $$| $$$$$$$$| $$ $$ $$| $$  | $$| $$$$$   | $$$$$$$/
 * | $$  | $$| $$__  $$| $$  $$$$| $$  | $$| $$__/   | $$__  $$
 * | $$  | $$| $$  | $$| $$\  $$$| $$  | $$| $$      | $$  \ $$
 * |  $$$$$$/| $$  | $$| $$ \  $$| $$$$$$$/| $$$$$$$$| $$  | $$
 *  \______/ |__/  |__/|__/  \__/|_______/ |________/|__/  |__/
 *
 * Oander_ApplePay
 *
 * @author  JÃ¡nos Pinczes <janos.pinczes@oander.hu>
 * @license Oander Media Kft. (http://www.oander.hu)
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <type name="Oander\CartButton\Model\CartButtonProviderDefault">
        <plugin name="oander_applepay_model_cartbuttonproviderdefault" type="Oander\ApplePay\Plugin\CartButton\Model\CartButtonProviderDefault"/>
    </type>
    <type name="Magento\Quote\Model\Quote\Address">
        <plugin name="oander_applepay_model_shippingrestriction" type="Oander\ApplePay\Plugin\Quote\Model\Quote\Address"/>
    </type>
    <type name="Magento\Quote\Model\QuoteRepository">
        <plugin name="oander_applepay_model_isactiverewrite" type="Oander\ApplePay\Plugin\Quote\Model\QuoteRepository"/>
    </type>
    <!-- Payment Method: Apple Pay -->
    <virtualType name="BraintreeApplePay" type="Magento\Payment\Model\Method\Adapter">
        <arguments>
            <argument name="code" xsi:type="const">Oander\ApplePay\Model\ApplePay\Ui\ConfigProvider::METHOD_CODE</argument>
            <argument name="valueHandlerPool" xsi:type="object">BraintreeApplePayValueHandlerPool</argument>
            <argument name="validatorPool" xsi:type="object">BraintreeApplePayValidatorPool</argument>
            <argument name="commandPool" xsi:type="object">BraintreeApplePayCommandPool</argument>
            <argument name="formBlockType" xsi:type="object">Magento\Payment\Block\Form</argument>
            <argument name="infoBlockType" xsi:type="string">Oander\ApplePay\Block\ApplePay\Info</argument>
        </arguments>
    </virtualType>
    <!-- valueHandlerPool -->
    <virtualType name="BraintreeApplePayValueHandlerPool" type="Magento\Payment\Gateway\Config\ValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">BraintreeApplePayConfigValueHandler</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="BraintreeApplePayConfigValueHandler" type="Magento\Payment\Gateway\Config\ConfigValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">BraintreeApplePayConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="BraintreeApplePayConfig" type="Magento\Payment\Gateway\Config\Config">
        <arguments>
            <argument name="methodCode" xsi:type="const">Oander\ApplePay\Model\ApplePay\Ui\ConfigProvider::METHOD_CODE</argument>
        </arguments>
    </virtualType>
    <!-- validatorPool -->
    <virtualType name="BraintreeApplePayValidatorPool" type="Magento\Payment\Gateway\Validator\ValidatorPool">
        <arguments>
            <argument name="validators" xsi:type="array">
                <item name="country" xsi:type="string">BraintreeCountryValidator</item>
            </argument>
        </arguments>
    </virtualType>
    <!-- commandPool -->
    <virtualType name="BraintreeApplePayCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="authorize" xsi:type="string">BraintreeApplePayAuthorizeCommand</item>
                <item name="sale" xsi:type="string">BraintreeApplePaySaleCommand</item>
                <item name="capture" xsi:type="string">BraintreeApplePayCaptureStrategyCommand</item>
                <item name="settlement" xsi:type="string">BraintreeCaptureCommand</item>
                <item name="void" xsi:type="string">BraintreeVoidCommand</item>
                <item name="refund" xsi:type="string">BraintreeRefundCommand</item>
                <item name="cancel" xsi:type="string">BraintreeVoidCommand</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="BraintreeApplePayAuthorizeCommand" type="Oander\ApplePay\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">BraintreeApplePayAuthorizeRequest</argument>
            <argument name="transferFactory" xsi:type="object">Magento\Braintree\Gateway\Http\TransferFactory</argument>
            <argument name="client" xsi:type="object">Magento\Braintree\Gateway\Http\Client\TransactionSale</argument>
            <argument name="handler" xsi:type="object">BraintreeApplePayAuthorizationHandler</argument>
            <argument name="validator" xsi:type="object">Magento\Braintree\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>
    <virtualType name="BraintreeApplePaySaleCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="transferFactory" xsi:type="object">Magento\Braintree\Gateway\Http\TransferFactory</argument>
            <argument name="client" xsi:type="object">Magento\Braintree\Gateway\Http\Client\TransactionSale</argument>
            <argument name="handler" xsi:type="object">BraintreeApplePayAuthorizationHandler</argument>
            <argument name="validator" xsi:type="object">Magento\Braintree\Gateway\Validator\ResponseValidator</argument>
            <argument name="requestBuilder" xsi:type="object">BraintreeApplePaySaleRequest</argument>
        </arguments>
    </virtualType>
    <virtualType name="BraintreeApplePayCaptureStrategyCommand" type="Magento\Braintree\Gateway\Command\CaptureStrategyCommand">
        <arguments>
            <argument name="commandPool" xsi:type="object">BraintreeApplePayCommandPool</argument>
        </arguments>
    </virtualType>

    <virtualType name="BraintreeApplePayAuthorizeRequest" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="customer" xsi:type="string">Magento\Braintree\Gateway\Request\CustomerDataBuilder</item>
                <item name="payment" xsi:type="string">Magento\Braintree\Gateway\Request\PaymentDataBuilder</item>
                <item name="channel" xsi:type="string">Magento\Braintree\Gateway\Request\ChannelDataBuilder</item>
                <item name="address" xsi:type="string">Magento\Braintree\Gateway\Request\AddressDataBuilder</item>
                <item name="dynamic_descriptor" xsi:type="string">Magento\Braintree\Gateway\Request\DescriptorDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="BraintreeApplePayAuthorizationHandler" type="Magento\Payment\Gateway\Response\HandlerChain">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="payment_details" xsi:type="string">Oander\ApplePay\Model\ApplePay\PaymentDetailsHandler</item>
                <item name="txn_id" xsi:type="string">Magento\Braintree\Gateway\Response\TransactionIdHandler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="BraintreeApplePaySaleRequest" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="authorize" xsi:type="string">BraintreeApplePayAuthorizeRequest</item>
                <item name="settlement" xsi:type="string">Magento\Braintree\Gateway\Request\SettlementDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Braintree validators infrastructure -->
    <virtualType name="BraintreeCountryValidator" type="Magento\Payment\Gateway\Validator\CountryValidator">
        <arguments>
            <argument name="config" xsi:type="object">Magento\Braintree\Gateway\Config\Config</argument>
        </arguments>
    </virtualType>

</config>